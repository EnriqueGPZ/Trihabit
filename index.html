<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TriHabit v15.0 - MultiScale Charts</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#151e32', 900: '#0f172a' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(148, 163, 184, 0.08); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; margin-top: -6px; box-shadow: 0 0 10px rgba(255,255,255,0.5); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 2px; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        [x-cloak] { display: none !important; }

        /* --- ANIMACIONES VISUALES --- */
        .chart-shine-container { position: relative; overflow: hidden; }
        .chart-shine-container::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.03) 50%, transparent 100%);
            transform: skewX(-20deg); animation: shine-scan 6s infinite ease-in-out; pointer-events: none; z-index: 10;
        }
        @keyframes shine-scan {
            0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; }
        }
        .breathe-effect { animation: breathe 8s ease-in-out infinite; }
        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
            50% { transform: scale(1.005); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-indigo-500 selection:text-white" x-data="app()" x-init="initApp()" x-cloak>

    <header class="glass h-16 shrink-0 flex items-center justify-between px-6 z-30 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                <i class="ph-bold ph-chart-polar"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-white leading-tight tracking-tight">TriHabit <span class="text-[10px] bg-white/10 px-1.5 py-0.5 rounded text-indigo-300 font-normal">v15.0</span></h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div x-show="savedMsg" x-transition.opacity.duration.500ms class="flex items-center gap-1 text-xs text-emerald-400 font-medium bg-emerald-900/30 px-3 py-1 rounded-full border border-emerald-500/20">
                <i class="ph-bold ph-check"></i> Guardado
            </div>
            <button @click="showSettings = true" class="w-9 h-9 rounded-full hover:bg-white/10 flex items-center justify-center transition-all duration-300 hover:rotate-90 text-slate-400 hover:text-white">
                <i class="ph ph-gear text-xl"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col lg:flex-row relative z-10 overflow-hidden h-[calc(100vh-64px)]">
        
        <!-- SECCIÓN IZQUIERDA: CALENDARIO -->
        <section class="flex-1 lg:flex-[0.4] flex flex-col p-4 lg:p-6 border-r border-slate-800/50 bg-slate-900/30 overflow-y-auto scrollbar-hide">
            
            <div class="flex justify-between items-end mb-8 px-1">
                <div>
                    <h2 class="text-3xl text-white font-bold capitalize tracking-tight" x-text="monthName"></h2>
                    <p class="text-slate-500 text-sm" x-text="year"></p>
                </div>
                <div class="flex bg-slate-800/80 rounded-xl p-1 shadow-inner border border-slate-700/50">
                    <button @click="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition"><i class="ph-bold ph-caret-left"></i></button>
                    <button @click="gotoToday()" class="px-3 text-xs font-bold text-indigo-400 hover:text-indigo-300 transition">HOY</button>
                    <button @click="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition"><i class="ph-bold ph-caret-right"></i></button>
                </div>
            </div>

            <div class="glass-panel p-5 mb-6 shadow-xl shadow-black/20">
                <div class="grid grid-cols-7 gap-3 mb-3">
                    <template x-for="d in ['D','L','M','M','J','V','S']"><div class="text-center text-[10px] text-slate-500 font-bold uppercase tracking-wider" x-text="d"></div></template>
                </div>
                <div class="grid grid-cols-7 gap-2 lg:gap-3">
                    <template x-for="b in blanks"><div class="aspect-square"></div></template>
                    <template x-for="day in daysInMonth" :key="day">
                        <div @click="selectDay(day)" 
                             class="aspect-square rounded-xl cursor-pointer flex flex-col items-center justify-center relative transition-all duration-200 group"
                             :class="getDayClass(day)">
                            
                            <span class="text-sm font-medium relative z-10" :class="isToday(day) ? 'text-white' : (selectedDay === day ? 'text-white' : 'text-slate-400')" x-text="day"></span>
                            
                            <div class="flex flex-wrap justify-center content-start gap-0.5 mt-1 w-full px-0.5 z-10">
                                <template x-for="(h, i) in habits">
                                    <div x-show="h.active" class="w-1.5 h-1.5 rounded-full transition-all duration-500 shrink-0" 
                                         :class="getVal(day, i) >= h.max ? 'shadow-[0_0_8px]' : ''"
                                         :style="getDotStyle(day, i, h)"></div>
                                </template>
                            </div>

                            <div class="absolute inset-0 bg-indigo-500/10 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity" x-show="selectedDay !== day"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- DETALLE DEL DÍA SELECCIONADO -->
            <div x-show="selectedDay" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="glass-panel p-6 border-l-4 relative overflow-hidden group" 
                 :style="`border-left-color: ${habits.find(h=>h.active)?.color || '#333'}`">
                
                <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 rounded-full blur-3xl -z-10"></div>

                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="ph-duotone ph-calendar-check text-indigo-400"></i>
                            Día <span x-text="selectedDay"></span> <span x-text="monthName"></span>
                        </h3>
                        <p class="text-xs text-slate-400 mt-1">Registra tu progreso diario</p>
                    </div>
                    <button @click="selectedDay = null" class="lg:hidden w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center"><i class="ph ph-x text-slate-400"></i></button>
                </div>

                <div class="space-y-6 max-h-[50vh] overflow-y-auto pr-2 scrollbar-hide">
                    <template x-for="(habit, idx) in habits" :key="idx">
                        <div x-show="habit.active" class="transition-all duration-300">
                            <div class="flex justify-between items-end mb-2">
                                <span class="font-bold text-sm text-white flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full shadow-[0_0_8px]" :style="`background: ${habit.color}; box-shadow: 0 0 10px ${habit.color}80`"></span>
                                    <span x-text="habit.name"></span>
                                </span>
                                <div class="text-xs font-mono">
                                    <template x-if="habit.type === 'check'">
                                        <span :class="getVal(selectedDay, idx) >= 1 ? 'text-green-400 font-bold' : 'text-slate-400'" 
                                              x-text="getVal(selectedDay, idx) >= 1 ? 'Completado' : 'Pendiente'"></span>
                                    </template>
                                    <template x-if="habit.type !== 'check'">
                                        <span>
                                            <span :class="getVal(selectedDay, idx) >= habit.max ? 'text-green-400 font-bold' : 'text-slate-400'" x-text="getVal(selectedDay, idx)"></span>
                                            <span class="text-slate-600">/</span>
                                            <span class="text-slate-500" x-text="`${habit.max} ${habit.unit}`"></span>
                                        </span>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Slider para Contador -->
                            <div x-show="habit.type !== 'check'" class="flex items-center gap-4 bg-slate-800/50 p-2 rounded-xl border border-slate-700/50">
                                <button @click="updateVal(idx, getVal(selectedDay, idx) - 1)" class="w-8 h-8 rounded-lg bg-slate-700/50 hover:bg-slate-600 text-white flex items-center justify-center active:scale-95 transition"><i class="ph-bold ph-minus"></i></button>
                                
                                <div class="relative flex-1 h-2 bg-slate-900 rounded-full overflow-hidden">
                                    <div class="absolute inset-0 bg-slate-800"></div>
                                    <div class="h-full transition-all duration-300 relative"
                                         :style="`width: ${Math.min((getVal(selectedDay, idx) / habit.max) * 100, 100)}%; background: ${habit.color}`">
                                         <div class="absolute right-0 top-0 bottom-0 w-2 bg-white/50 blur-[2px]"></div>
                                    </div>
                                    <input type="range" min="0" :max="habit.max" step="1" 
                                           class="absolute inset-0 w-full h-full opacity-0 z-10"
                                           :value="getVal(selectedDay, idx)"
                                           @input="updateVal(idx, $el.value)">
                                </div>

                                <button @click="updateVal(idx, getVal(selectedDay, idx) + 1)" class="w-8 h-8 rounded-lg bg-slate-700/50 hover:bg-slate-600 text-white flex items-center justify-center active:scale-95 transition"><i class="ph-bold ph-plus"></i></button>
                            </div>

                            <!-- Botón para Check -->
                            <div x-show="habit.type === 'check'" 
                                 @click="toggleCheck(idx)"
                                 class="relative cursor-pointer group h-12 bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden flex items-center justify-center transition-all duration-300"
                                 :class="getVal(selectedDay, idx) >= 1 ? 'border-transparent' : 'hover:bg-slate-800'">
                                
                                <div class="absolute inset-0 opacity-0 transition-opacity duration-500 ease-out"
                                     :class="getVal(selectedDay, idx) >= 1 ? 'opacity-100' : ''"
                                     :style="`background: ${habit.color}; opacity: ${getVal(selectedDay, idx) >= 1 ? 0.2 : 0}`"></div>
                                
                                <div class="absolute inset-0 opacity-0 transition-opacity duration-500"
                                     :class="getVal(selectedDay, idx) >= 1 ? 'opacity-100' : ''"
                                     :style="`box-shadow: inset 0 0 20px ${habit.color}40`"></div>

                                <div class="flex items-center gap-2 relative z-10 font-bold transition-all duration-300"
                                     :class="getVal(selectedDay, idx) >= 1 ? 'text-white scale-110' : 'text-slate-400 group-hover:text-slate-200'">
                                    <i class="ph-bold" :class="getVal(selectedDay, idx) >= 1 ? 'ph-check-circle' : 'ph-circle'"></i>
                                    <span x-text="getVal(selectedDay, idx) >= 1 ? '¡HECHO!' : 'MARCAR COMO HECHO'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div x-show="!habits.some(h=>h.active)" class="text-center text-slate-500 text-sm py-4 italic">
                        Configura tus retos en el icono de engranaje.
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN DERECHA: ESTADÍSTICAS Y LOGROS -->
        <section class="flex-1 lg:flex-[0.6] flex flex-col p-6 bg-slate-950 relative overflow-hidden">
            
            <div class="flex gap-4 mb-6 shrink-0 border-b border-slate-800 pb-4">
                <button @click="viewMode = 'stats'; forceRedraw()" class="text-sm font-bold flex items-center gap-2 pb-1 border-b-2 transition" :class="viewMode === 'stats' ? 'text-white border-indigo-500' : 'text-slate-500 border-transparent hover:text-slate-300'">
                    <i class="ph-bold ph-chart-line-up"></i> Progreso
                </button>
                <button @click="viewMode = 'insights'" class="text-sm font-bold flex items-center gap-2 pb-1 border-b-2 transition" :class="viewMode === 'insights' ? 'text-white border-indigo-500' : 'text-slate-500 border-transparent hover:text-slate-300'">
                    <i class="ph-bold ph-trophy"></i> Logros & Rachas
                </button>
            </div>

            <div x-show="viewMode === 'stats'" x-transition.opacity class="flex flex-col h-full min-h-0 overflow-y-auto pr-2 scrollbar-hide">
                
                <!-- Totales arriba -->
                <div class="flex gap-2 mb-6 overflow-x-auto pb-2 shrink-0 scrollbar-hide">
                    <template x-for="(h, i) in habits">
                        <div x-show="h.active" class="glass-panel p-3 min-w-[120px] flex-1 border-t-2" :style="`border-top-color: ${h.color}`">
                            <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1" x-text="h.name"></div>
                            <div class="text-2xl font-bold text-white leading-none">
                                <span x-text="calcTotal(i)"></span> 
                                <span class="text-[10px] font-normal text-slate-500" x-show="h.type !== 'check'" x-text="h.unit"></span>
                                <span class="text-[10px] font-normal text-slate-500" x-show="h.type === 'check'">días</span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- AQUÍ ESTÁ EL CAMBIO PRINCIPAL: GRÁFICAS INDIVIDUALES -->
                <div class="mb-6 shrink-0">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-chart-line-up"></i> Tendencias Individuales (<span x-text="monthName"></span>)
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <template x-for="(h, i) in habits" :key="i">
                            <div x-show="h.active" class="glass-panel p-4 chart-shine-container breathe-effect flex flex-col h-[220px]">
                                <!-- Título de cada tarjeta de gráfica -->
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-bold uppercase tracking-wider truncate mr-2" :style="`color: ${h.color}`" x-text="h.name"></span>
                                    <span class="text-[10px] text-slate-500 whitespace-nowrap" x-text="h.type === 'check' ? 'Constancia' : h.unit"></span>
                                </div>
                                
                                <!-- Canvas Contenedor -->
                                <div class="relative flex-1 min-h-0 w-full">
                                    <canvas :id="'chart-' + i"></canvas>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

            </div>

            <!-- VISTA DE INSIGHTS (LOGROS) -->
            <div x-show="viewMode === 'insights'" x-transition.opacity class="grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min overflow-y-auto pr-2 scrollbar-hide h-full">
                
                <div class="glass-panel p-5 md:col-span-2 bg-gradient-to-r from-slate-900 to-slate-800 shrink-0">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-fire text-orange-500"></i> Estadísticas de Rachas</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <template x-for="(h, i) in habits">
                            <div x-show="h.active" class="bg-slate-900/50 rounded-xl p-3 border border-slate-700/50 flex flex-col items-center">
                                <div class="text-xs font-bold text-indigo-200 mb-2 truncate max-w-full" x-text="h.name"></div>
                                <div class="flex items-end justify-between w-full px-2">
                                    <div class="flex flex-col items-center flex-1 border-r border-slate-700/50 pr-2">
                                        <div class="text-2xl font-black text-white" x-text="getCurrentStreak(i)"></div>
                                        <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">ACTUAL</div>
                                    </div>
                                    <div class="flex flex-col items-center flex-1 pl-2">
                                        <div class="text-2xl font-black text-orange-400" x-text="getBestStreak(i)"></div>
                                        <div class="text-[9px] text-orange-500/70 uppercase font-bold tracking-wider">RÉCORD</div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="glass-panel p-5 md:col-span-2 shrink-0">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-target text-indigo-400"></i> Objetivos Mensuales</h3>
                    <div class="space-y-5">
                        <template x-for="(h, i) in habits">
                            <div x-show="h.active" class="group">
                                <div class="flex justify-between items-end mb-1">
                                    <div class="flex items-center gap-2">
                                        <i :class="getBadge(i).icon + ' ' + getBadge(i).text"></i>
                                        <span class="text-white font-bold text-sm" x-text="h.name"></span>
                                    </div>
                                    <div class="text-xs font-mono text-slate-400">
                                        <span class="text-white" x-text="getProgressText(i)"></span>
                                    </div>
                                </div>
                                <div class="h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700 relative">
                                    <div class="absolute inset-0 w-full h-full opacity-10" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #fff 5px, #fff 10px);"></div>
                                    <div class="h-full rounded-full transition-all duration-700 ease-out relative flex items-center justify-end pr-1"
                                         :class="getBadge(i).bar" :style="`width: ${getCompletionRate(i)}%`"></div>
                                </div>
                                <div class="flex justify-between mt-1 items-center">
                                    <span class="text-[10px] uppercase font-bold tracking-wider" :class="getBadge(i).text" x-text="getBadge(i).label"></span>
                                    <div x-show="getRemaining(i) > 0" class="text-[10px] text-slate-500 flex items-center gap-1">
                                        Faltan <span class="text-white font-mono" x-text="Math.round(getRemaining(i))"></span> 
                                        <span x-show="h.type !== 'check'" x-text="h.unit"></span><span x-show="h.type === 'check'">días</span>
                                    </div>
                                    <div x-show="getRemaining(i) <= 0" class="text-[10px] text-emerald-400 font-bold flex items-center gap-1">¡Objetivo Cumplido! <i class="ph-bold ph-check-circle"></i></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="glass-panel p-5 md:col-span-2 bg-indigo-900/20 border-indigo-500/20 animate-float shrink-0">
                    <div class="flex gap-4 items-start">
                        <div class="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400"><i class="ph-fill ph-quotes text-xl"></i></div>
                        <div><h4 class="text-indigo-300 font-bold text-sm mb-1">TriHabit Coach</h4><p class="text-sm text-indigo-100 italic" x-text="quoteOfTheDay"></p></div>
                    </div>
                </div>
            </div>
            
        </section>
    </main>

    <!-- MODAL DE CONFIGURACIÓN -->
    <div x-show="showSettings" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-md px-4" style="display:none" x-transition.opacity>
        <div class="glass-panel p-6 w-full max-w-lg shadow-2xl bg-slate-900 border border-slate-700" @click.away="showSettings = false"
             x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Configurar Hábitos (Máx. 10)</h2>
                <button @click="showSettings = false" class="text-slate-400 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="space-y-3 mb-6 max-h-[50vh] overflow-y-auto pr-2">
                <template x-for="(h, i) in tempHabits" :key="i">
                    <div class="flex flex-col gap-2 bg-slate-800/40 p-3 rounded-xl border border-slate-700/50 transition-colors hover:bg-slate-800/80" :class="!h.active ? 'opacity-50 grayscale' : ''">
                        <div class="flex gap-3 items-center">
                            <div class="flex items-center">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" x-model="h.active" class="sr-only peer">
                                    <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-500"></div>
                                </label>
                            </div>
                            <div class="relative group">
                                <input type="color" x-model="h.color" class="w-8 h-8 bg-transparent border-none cursor-pointer rounded-full overflow-hidden shrink-0 opacity-0 absolute inset-0 z-10">
                                <div class="w-8 h-8 rounded-full shadow-sm" :style="`background: ${h.color}`"></div>
                            </div>
                            <div class="flex-1">
                                <input type="text" x-model="h.name" :placeholder="`Hábito ${i+1}`" class="w-full bg-transparent text-white font-bold border-b border-slate-600 focus:border-indigo-500 focus:border-b-2 outline-none text-sm py-1 transition-colors placeholder-slate-600">
                            </div>
                        </div>
                        <div class="flex gap-3 items-end pl-12">
                            <div class="flex-1">
                                <label class="text-[9px] text-slate-500 uppercase font-bold px-1 block mb-1">Tipo</label>
                                <select x-model="h.type" @change="if(h.type === 'check') h.max = 1" class="w-full bg-slate-900 text-slate-300 text-xs rounded-lg border border-slate-700 px-2 py-1 focus:outline-none focus:border-indigo-500">
                                    <option value="contador">Contador</option>
                                    <option value="check">Check (Sí/No)</option>
                                </select>
                            </div>
                            <div x-show="h.type !== 'check'" class="w-20">
                                <label class="text-[9px] text-slate-500 uppercase font-bold px-1 text-right block mb-1">Meta</label>
                                <input type="number" x-model="h.max" class="w-full bg-slate-900 text-white text-right rounded-lg border border-slate-700 px-2 py-1 outline-none text-xs font-mono focus:border-indigo-500">
                            </div>
                            <div x-show="h.type !== 'check'" class="w-16">
                                <label class="text-[9px] text-slate-500 uppercase font-bold px-1 mb-1 block">Unidad</label>
                                <input type="text" x-model="h.unit" class="w-full bg-slate-900 text-slate-300 text-center rounded-lg border border-slate-700 px-2 py-1 outline-none text-xs focus:border-indigo-500">
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div class="mb-4 pt-4 border-t border-slate-800">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Gestión de Datos</h4>
                <div class="flex gap-2">
                    <button @click="exportData()" class="flex-1 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-indigo-300 text-xs font-bold py-2 px-3 rounded-lg border border-slate-700 transition">
                        <i class="ph-bold ph-download-simple"></i> Exportar Copia
                    </button>
                    <button @click="triggerImport()" class="flex-1 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-emerald-300 text-xs font-bold py-2 px-3 rounded-lg border border-slate-700 transition">
                        <i class="ph-bold ph-upload-simple"></i> Importar Copia
                    </button>
                    <input type="file" x-ref="fileInput" class="hidden" accept=".json" @change="handleImport($event)">
                </div>
            </div>

            <div class="flex justify-between items-center border-t border-slate-800 pt-5">
                <button @click="resetAll()" class="text-red-500 text-xs hover:text-red-400 flex items-center gap-1"><i class="ph ph-trash"></i> Resetear Datos</button>
                <div class="flex gap-3">
                    <button @click="showSettings = false" class="text-slate-400 text-sm hover:text-white px-3 py-2">Cancelar</button>
                    <button @click="saveSettings()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-indigo-500 shadow-lg shadow-indigo-500/20 transition hover:scale-105">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                habits: [],
                logs: {},
                historicalBest: {},
                tempHabits: [],
                currentDate: new Date(),
                selectedDay: null,
                showSettings: false,
                savedMsg: false,
                viewMode: 'stats', 
                charts: {}, // AHORA ES UN OBJETO PARA MÚLTIPLES GRÁFICAS
                quoteOfTheDay: '', 
                motivationalQuotes: [
                    "Hoy no busques perfección, busca avanzar un paso más que ayer.",
                    "Aunque no te apetezca, hacerlo igual es donde empieza el cambio.",
                    "No hace falta motivación todos los días, hace falta rutina.",
                    "Cinco minutos ahora valen más que una hora “cuando tenga tiempo”.",
                    "Lo difícil no es empezar, es seguir cuando ya no es novedad.",
                    "Hazlo sencillo, hazlo posible, pero hazlo.",
                    "La disciplina es hacer lo que dijiste que harías incluso cuando nadie mira."
                ],
                palette: ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#3b82f6', '#6366f1', '#84cc16', '#a855f7'],

                get daysInMonth() { return new Date(this.year, this.month + 1, 0).getDate(); },
                get blanks() { return new Date(this.year, this.month, 1).getDay(); },
                get month() { return this.currentDate.getMonth(); },
                get year() { return this.currentDate.getFullYear(); },
                get monthName() { return this.currentDate.toLocaleString('es-ES', { month: 'long' }); },

                initApp() {
                    const cfg = localStorage.getItem('trihabit_config_v14');
                    const dat = localStorage.getItem('trihabit_logs_v14');
                    const maxHabits = 10;
                    
                    if (cfg) {
                        this.habits = JSON.parse(cfg);
                        if (this.habits.length < maxHabits) {
                            for (let i = this.habits.length; i < maxHabits; i++) {
                                this.habits.push({ id: i, name: `Hábito ${i+1}`, max: 1, unit: 'u', color: this.palette[i] || '#cbd5e1', active: false, type: 'check' });
                            }
                        }
                    } else {
                        // Migración básica o defaults
                        const oldCfg = localStorage.getItem('trihabit_config_v9');
                        if (oldCfg) {
                            this.habits = JSON.parse(oldCfg);
                        } else {
                            this.habits = [];
                            this.habits.push({ id: 0, name: 'Flexiones', max: 50, unit: 'reps', color: this.palette[0], active: true, type: 'contador' });
                            this.habits.push({ id: 1, name: 'Lectura', max: 30, unit: 'min', color: this.palette[1], active: true, type: 'contador' });
                            this.habits.push({ id: 2, name: 'Meditar', max: 1, unit: '', color: this.palette[2], active: true, type: 'check' });
                            for(let i=3; i<maxHabits; i++) { this.habits.push({ id: i, name: `Hábito ${i+1}`, max: 1, unit: 'u', color: this.palette[i], active: false, type: 'check' }); }
                        }
                    }

                    if (dat) {
                        this.logs = JSON.parse(dat);
                    } else {
                        const oldDat = localStorage.getItem('trihabit_logs_v9');
                        if (oldDat) this.logs = JSON.parse(oldDat);
                    }
                    
                    this.tempHabits = JSON.parse(JSON.stringify(this.habits));
                    this.quoteOfTheDay = this.motivationalQuotes[Math.floor(Math.random() * this.motivationalQuotes.length)];
                    this.gotoToday();
                    this.calculateAllHistoricalBests();
                    
                    this.$nextTick(() => { setTimeout(() => this.initChart(), 300); });
                    
                    // Listener de respaldo para cualquier cambio en logs
                    this.$watch('logs', () => { 
                        this.saveData(); 
                        this.calculateAllHistoricalBests();
                    });
                },

                saveData() {
                    localStorage.setItem('trihabit_config_v14', JSON.stringify(this.habits));
                    localStorage.setItem('trihabit_logs_v14', JSON.stringify(this.logs));
                    this.savedMsg = true;
                    setTimeout(() => this.savedMsg = false, 1500);
                },

                exportData() {
                    const dataToExport = {
                        config: this.habits,
                        logs: this.logs,
                        version: 'v14.1',
                        exportedAt: new Date().toISOString()
                    };
                    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = new Date().toISOString().split('T')[0];
                    a.download = `trihabit_backup_${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },

                triggerImport() {
                    this.$refs.fileInput.click();
                },

                handleImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            if (importedData.config && importedData.logs) {
                                if (confirm('Esto sobrescribirá tus datos actuales con los del archivo. ¿Estás seguro?')) {
                                    this.habits = importedData.config;
                                    this.logs = importedData.logs;
                                    this.tempHabits = JSON.parse(JSON.stringify(this.habits));
                                    this.saveData();
                                    this.calculateAllHistoricalBests();
                                    this.forceRedraw();
                                    this.showSettings = false; 
                                    alert('¡Datos importados correctamente!');
                                }
                            } else {
                                alert('Error: El archivo no tiene el formato correcto de TriHabit.');
                            }
                        } catch (err) {
                            alert('Error al leer el archivo. Asegúrate de que es un JSON válido.');
                            console.error(err);
                        }
                        event.target.value = '';
                    };
                    reader.readAsText(file);
                },

                getKey(day) { return `${this.year}-${(this.month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`; },
                dateToKey(dateObj) { return `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}-${dateObj.getDate().toString().padStart(2, '0')}`; },
                
                gotoToday() { 
                    this.currentDate = new Date(); 
                    this.selectedDay = this.currentDate.getDate(); 
                },
                
                changeMonth(val) { 
                    this.currentDate = new Date(this.year, this.month + val, 1); 
                    this.selectedDay = null; 
                    this.forceRedraw(); 
                },
                
                selectDay(day) { this.selectedDay = day; },
                
                isToday(day) { 
                    const t = new Date(); 
                    return day === t.getDate() && this.month === t.getMonth() && this.year === t.getFullYear(); 
                },
                
                getDayClass(day) {
                    if (this.selectedDay === day) return 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/40 ring-2 ring-indigo-400 transform scale-105 z-20';
                    if (this.isToday(day)) return 'bg-slate-800 border border-indigo-500/50';
                    return 'bg-slate-800/40 hover:bg-slate-700/80';
                },
                
                getDotStyle(day, idx, habit) {
                    const val = this.getVal(day, idx);
                    if (val === 0) return 'background: rgba(255,255,255,0.05)';
                    if (val >= habit.max) return `background: ${habit.color}`;
                    return `background: ${habit.color}; opacity: 0.5`;
                },
                
                getVal(day, idx) { const key = this.getKey(day); return this.logs[key] ? (this.logs[key][idx] || 0) : 0; },
                
                updateVal(idx, val) {
                    if (!this.selectedDay) return;
                    const parsedVal = val === '' ? 0 : parseFloat(val);
                    if (parsedVal < 0) return;
                    const key = this.getKey(this.selectedDay);
                    if (!this.logs[key]) this.logs[key] = []; 
                    const prevVal = this.logs[key][idx] || 0;
                    const max = this.habits[idx].max;
                    
                    if (prevVal < max && parsedVal >= max) { this.celebrate(); }
                    
                    this.logs[key][idx] = parsedVal;
                    this.logs = { ...this.logs }; 
                    this.forceRedraw();
                },
                
                toggleCheck(idx) { const current = this.getVal(this.selectedDay, idx); this.updateVal(idx, current >= 1 ? 0 : 1); },
                
                calcTotal(idx) {
                    const prefix = `${this.year}-${(this.month+1).toString().padStart(2,'0')}`;
                    return Object.keys(this.logs).filter(k => k.startsWith(prefix)).reduce((acc, k) => acc + (this.logs[k][idx] || 0), 0);
                },
                
                celebrate() {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: [this.habits.find(h=>h.active)?.color || '#fff', '#ffffff'] });
                },
                
                checkHabitDone(dateObj, idx) {
                    const key = this.dateToKey(dateObj);
                    const val = this.logs[key] ? (this.logs[key][idx] || 0) : 0;
                    return val >= this.habits[idx].max;
                },
                
                getCurrentStreak(idx) {
                    let streak = 0;
                    let d = new Date();
                    if (this.checkHabitDone(d, idx)) { streak++; d.setDate(d.getDate() - 1); } 
                    else { 
                        d.setDate(d.getDate() - 1); 
                        if (!this.checkHabitDone(d, idx)) return 0; 
                    }
                    while(true) {
                        if (this.checkHabitDone(d, idx)) { streak++; d.setDate(d.getDate() - 1); } 
                        else { break; }
                        if (streak > 2000) break;
                    }
                    return streak;
                },
                
                calculateAllHistoricalBests() { this.habits.forEach((h, idx) => { this.historicalBest[idx] = this.calcMaxStreak(idx); }); },
                
                getBestStreak(idx) { const current = this.getCurrentStreak(idx); const historic = this.historicalBest[idx] || 0; return Math.max(current, historic); },
                
                calcMaxStreak(idx) {
                    const keys = Object.keys(this.logs).sort();
                    if (keys.length === 0) return 0;
                    let maxStreak = 0; let currentRun = 0;
                    const firstDateStr = keys[0]; const firstDate = new Date(firstDateStr); const today = new Date();
                    let iteratorDate = new Date(firstDate);
                    
                    while(iteratorDate <= today) {
                        if (this.checkHabitDone(iteratorDate, idx)) { currentRun++; } 
                        else { if (currentRun > maxStreak) maxStreak = currentRun; currentRun = 0; }
                        iteratorDate.setDate(iteratorDate.getDate() + 1);
                    }
                    if (currentRun > maxStreak) maxStreak = currentRun;
                    return maxStreak;
                },
                
                getCompletionRate(idx) {
                    const totalMonthGoal = this.habits[idx].max * this.daysInMonth;
                    let currentTotal = 0;
                    for(let i=1; i<=this.daysInMonth; i++) { currentTotal += this.getVal(i, idx); }
                    if (totalMonthGoal === 0) return 0;
                    let pct = (currentTotal / totalMonthGoal) * 100;
                    return Math.min(pct, 100);
                },
                
                getProgressText(idx) {
                    const totalMonthGoal = this.habits[idx].max * this.daysInMonth;
                    let currentTotal = 0;
                    for(let i=1; i<=this.daysInMonth; i++) { currentTotal += this.getVal(i, idx); }
                    if (this.habits[idx].type === 'check') { return `${Math.round(currentTotal)} / ${this.daysInMonth} días`; }
                    return `${Math.round(currentTotal)} / ${totalMonthGoal} ${this.habits[idx].unit}`;
                },
                
                getRemaining(idx) {
                    const totalMonthGoal = this.habits[idx].max * this.daysInMonth;
                    let currentTotal = 0;
                    for(let i=1; i<=this.daysInMonth; i++) { currentTotal += this.getVal(i, idx); }
                    const left = totalMonthGoal - currentTotal;
                    return left > 0 ? left : 0;
                },
                
                getBadge(idx) {
                    const rate = this.getCompletionRate(idx);
                    if(rate >= 100) return { icon: 'ph-fill ph-crown', label: 'Legendario', bg: 'bg-indigo-500/20 text-indigo-400 shadow-[0_0_15px_rgba(99,102,241,0.3)]', bar: 'bg-indigo-500 shadow-[0_0_10px_#6366f1]', text: 'text-indigo-400 font-bold' };
                    if(rate >= 90) return { icon: 'ph-fill ph-trophy', label: 'Oro', bg: 'bg-yellow-500/20 text-yellow-400', bar: 'bg-yellow-400', text: 'text-yellow-400' };
                    if(rate >= 75) return { icon: 'ph-fill ph-medal', label: 'Plata', bg: 'bg-slate-300/20 text-slate-300', bar: 'bg-slate-300', text: 'text-slate-300' };
                    if(rate >= 50) return { icon: 'ph-fill ph-medal', label: 'Bronce', bg: 'bg-orange-700/20 text-orange-600', bar: 'bg-orange-600', text: 'text-orange-600' };
                    return { icon: 'ph-duotone ph-star', label: 'Inicial', bg: 'bg-slate-800 text-slate-600', bar: 'bg-slate-700', text: 'text-slate-600' };
                },
                
                saveSettings() {
                    this.tempHabits.forEach(h => { if(h.type === 'check') h.max = 1; });
                    this.habits = JSON.parse(JSON.stringify(this.tempHabits));
                    this.saveData();
                    this.showSettings = false;
                    this.initChart();
                    this.calculateAllHistoricalBests();
                },
                
                resetAll() { if(confirm("¿Estás seguro de borrar todos tus datos? No se pueden recuperar.")) { localStorage.clear(); location.reload(); } },

                // --- NUEVA LÓGICA DE REDIBUJADO MÚLTIPLE ---
                forceRedraw() {
                    // Limpiar todas las gráficas existentes
                    if (this.charts) {
                        Object.values(this.charts).forEach(c => c.destroy());
                    }
                    this.charts = {};
                    
                    this.$nextTick(() => {
                        this.initChart();
                    });
                },

                initChart() {
                    // Config global
                    Chart.defaults.color = '#64748b';
                    Chart.defaults.font.family = "'Inter', 'system-ui', 'sans-serif'";

                    // Recorrer hábitos activos
                    this.habits.forEach((h, index) => {
                        if (!h.active) return;

                        // Esperar a que el DOM pinte los canvas
                        this.$nextTick(() => {
                            const ctxCanvas = document.getElementById('chart-' + index);
                            if (!ctxCanvas) return;

                            // Seguridad: destruir si existe
                            if (this.charts[index]) {
                                this.charts[index].destroy();
                            }

                            // Opciones específicas para gráficas individuales
                            const chartOptions = {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: { duration: 1000, easing: 'easeOutQuart' },
                                interaction: { mode: 'index', intersect: false },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                        titleColor: '#fff',
                                        bodyFont: { size: 12 },
                                        padding: 10,
                                        borderColor: 'rgba(255,255,255,0.1)',
                                        borderWidth: 1,
                                        displayColors: false,
                                        callbacks: {
                                            label: function(context) {
                                                // Texto personalizado del tooltip
                                                return context.parsed.y + (h.type === 'check' ? (context.parsed.y === 1 ? ' (Sí)' : ' (No)') : ' ' + h.unit);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { display: false }, // Ocultar eje X para diseño limpio
                                    y: {
                                        display: true,
                                        grid: { color: 'rgba(255,255,255,0.03)' },
                                        border: { display: false },
                                        beginAtZero: true,
                                        ticks: { 
                                            font: { size: 9 }, 
                                            maxTicksLimit: 4, 
                                            callback: function(value) { return Number.isInteger(value) ? value : ''; }
                                        },
                                        // ESCALA INDEPENDIENTE: Basada en el max de cada hábito
                                        suggestedMax: h.type === 'check' ? 1.2 : (h.max * 1.1)
                                    }
                                },
                                elements: {
                                    line: { tension: 0.4, borderWidth: 2 },
                                    point: { radius: 0, hitRadius: 20, hoverRadius: 5 }
                                }
                            };

                            // Datos
                            const daysLabels = Array.from({length: this.daysInMonth}, (_, i) => i + 1);
                            const dataValues = daysLabels.map(d => this.getVal(d, index));

                            // Crear instancia
                            const newChart = new Chart(ctxCanvas, {
                                type: 'line',
                                data: {
                                    labels: daysLabels,
                                    datasets: [{
                                        label: h.name,
                                        data: dataValues,
                                        borderColor: h.color,
                                        backgroundColor: (context) => {
                                            const ctx = context.chart.ctx;
                                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                                            gradient.addColorStop(0, h.color + '60');
                                            gradient.addColorStop(1, h.color + '00');
                                            return gradient;
                                        },
                                        fill: true,
                                        pointBackgroundColor: '#1e293b',
                                        pointBorderColor: h.color,
                                        pointHoverBackgroundColor: '#fff',
                                        pointHoverBorderColor: h.color,
                                    }]
                                },
                                options: chartOptions
                            });

                            this.charts[index] = newChart;
                        });
                    });
                },

                updateChartData() {
                    this.forceRedraw();
                }
            }
        }
    </script>
</body>
</html>
